#Makefile for johnnyfive with ifort-19.1.2 compiler

SHELL = /bin/bash

DEBUG = false#{true, false}  (NOTE: no whitespace at end)

FC = ifort

#*************************************************

ifeq ($(DEBUG), true)
FCFLAGS = -c -O0 -warn -traceback  -standard-semantics \
		  -fp-model consistent -fpe-all=3
else
FCFLAGS = -c -O3 -standard-semantics -inline -ipo
endif

SRC_DIR = ../src
BUILD_DIR = .
INSTALL_DIR = ../bin
EXECUTABLE = brownpak-rr

vpath %.f90 $(SRC_DIR)
vpath %.fpp $(SRC_DIR)
vpath $(EXECUTABLE) $(INSTALL_DIR)

#Compiled MKL interfaces
MKL_INTRFC = $(HOME)/soft/mkl-intrfc-ifort

INCS = \
	-I$(SRC_DIR) \
	-I$(MKL_INTRFC) \
	-I$(MKLROOT)/include/intel64/lp64

LIBS = \
	$(MKLROOT)/lib/intel64/libmkl_blas95_lp64.a \
	$(MKLROOT)/lib/intel64/libmkl_lapack95_lp64.a \
	-L$(MKLROOT)/lib/intel64 -lmkl_intel_lp64 \
	-lmkl_sequential -lmkl_core -lpthread -lm -ldl

FYPPFLAGS = #-D DEBUG=1

OBJ_NAMES = \
		  m_precision        \
		  m_constants_math   \
		  m_utils_math       \
		  m_strings          \
		  m_logger           \
          m_ran_num          \
		  m_qsort            \
		  m_vector           \
		  m_table            \
		  m_aabb             \
		  m_aabbtree         \
		  sm_aabbtree        \
		  m_trajectory       \
		  m_simbox           \
		  m_globals          \
		  m_control_io       \
		  m_config_io        \
		  m_stats_io         \
		  m_connectivity     \
		  m_cell_list        \
		  m_pairtab          \
		  m_ia_bond          \
		  m_ia_angle         \
		  m_ia_dihedral      \
		  m_ia_vdw           \
		  m_ia_tether        \
		  m_ia_external      \
		  m_interaction      \
		  m_relax            \
		  m_brown            \
		  m_bd_solver        \
		  m_mpcd             \
		  m_setup            \
		  main  

OBJECTS = $(addsuffix .o,$(OBJ_NAMES))

move : $(EXECUTABLE)
	if [ -e "$(EXECUTABLE)" ]; then mv $(EXECUTABLE) $(INSTALL_DIR);fi 

$(EXECUTABLE) : $(OBJECTS)
	$(FC) $(INCS) $^ $(LIBS) -o $@

$(OBJECTS) : %.o : %.f90
	$(FC) $(INCS) $(FCFLAGS) $^ -o $@

%.f90 : %.fpp
	fypp $(FYPPFLAGS) $< $@

%.o : %.f90
	$(FC) $(INCS) $(FCFLAGS) $^ -o $@

docs :
	ford ../docs/brownpak.md 

.PHONY : clean clobber
clean:
	-rm -rf *.o *.mod *.smod $(BUILD_DIR)/*.f90
clobber:
	-rm -rf $(INSTALL_DIR)/$(EXECUTABLE) *.o *.mod *.smod $(BUILD_DIR)/*.f90
